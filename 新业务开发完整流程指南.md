# 新业务开发完整流程指南

本文档总结创建一个新业务模块的完整流程，包含前端文件创建、数据库连接、前后端交互等步骤。

## 一、准备工作

### 1.1 确定业务需求
- 明确业务功能点
- 确定所属角色（admin/doctor/nurse/patient/executive/finance等）
- 确定业务组名称（如：forum-management、nursing-service）

### 1.2 数据库设计
- 设计数据库表结构
- 创建表（在MySQL中执行SQL）
- 插入测试数据

## 二、后端开发（Java）

### 2.1 创建 Entity 实体类
**文件路径**: `src/entity/[EntityName].java`

**命名规范**:
- 实体类名与数据库表名对应（首字母大写，驼峰命名）
- 例如：`forum_post` 表 → `ForumPost.java`
- 例如：`nursing_task` 表 → `NursingTask.java`

**包含内容**:
- 私有字段（对应数据库列）
- 关联查询字段（用于JOIN查询时显示关联信息）
- 无参构造函数
- Getter/Setter 方法
- 辅助方法（如时间格式化）

**示例文件**:
- `ForumPost.java`
- `ForumSection.java`
- `NursingTask.java`

### 2.2 创建 DAO 数据访问对象
**文件路径**: `src/dao/[EntityName]DAO.java`

**命名规范**:
- DAO类名 = Entity类名 + DAO
- 例如：`ForumPost.java` → `ForumPostDAO.java`

**主要方法**:
- `getAllXXX()` - 获取所有记录（可带筛选条件）
- `getXXXById(String id)` - 根据ID获取单条记录
- `createXXX(XXX entity)` - 创建新记录
- `updateXXX(XXX entity)` - 更新记录
- `updateStatus(String id, String newStatus)` - 更新状态（如需要）
- `deleteXXX(String id)` - 删除记录（如需要）

**注意事项**:
- 使用 `DBUtil.getConnection()` 获取数据库连接
- 使用 `PreparedStatement` 防止SQL注入
- 关联查询时使用 `LEFT JOIN` 获取关联表信息
- 更新操作建议使用事务控制（`setAutoCommit(false)`, `commit()`, `rollback()`）

**示例文件**:
- `ForumPostDAO.java`
- `ForumSectionDAO.java`
- `NursingTaskDAO.java`

### 2.3 创建 Servlet 控制器
**文件路径**: `src/servlet/[角色路径]/[业务名称]Servlet.java`

**路径规范**:
- 根据角色确定路径：
  - 管理员：`src/servlet/admin/`
  - 医生：`src/servlet/hospital/doctor/`
  - 护士：`src/servlet/hospital/nurse/`
  - 高管：`src/servlet/hospital/executive/`
  - 财务：`src/servlet/hospital/finance/`
  - 患者：`src/servlet/patient/`

**命名规范**:
- Servlet类名 = 业务名称 + Servlet
- 例如：`ForumServlet.java`、`MedicalServiceServlet_Nurse.java`

**注解配置**:
```java
@WebServlet("/servlet/[角色路径]/[业务名称]Servlet")
```

**主要功能**:
- 处理前端请求（`doPost` 方法）
- 根据 `action` 参数分发不同操作
- 调用 DAO 进行数据库操作
- 返回 JSON 格式数据给前端

**常用 action**:
- `action=list` - 获取列表数据
- `action=create` - 创建新记录
- `action=update` - 更新记录
- `action=updateStatus` - 更新状态
- `action=delete` - 删除记录

**返回格式**:
- JSON 数组（列表数据）
- JSON 对象（单条数据）
- 字符串（success/fail/error）

**示例文件**:
- `ForumServlet.java` (高管端)
- `MedicalServiceServlet_Nurse.java` (护士端)

## 三、前端开发

### 3.1 创建 HTML 文件
**文件路径**: `WebRoot/business/html/[角色路径]/[业务组名称]/[页面名称].html`

**路径规范**:
- 根据角色确定路径：
  - 管理员：`WebRoot/business/html/admin/`
  - 医生：`WebRoot/business/html/hospital/doctor/`
  - 护士：`WebRoot/business/html/nurse/`
  - 高管：`WebRoot/business/html/executive/`
  - 财务：`WebRoot/business/html/hospital/finance/`
  - 患者：`WebRoot/business/html/patient/`

**文件结构**:
```html
<div class="business-content-item active">
    <!-- 页面标题 -->
    <div class="content-header-row">
        <h2>页面标题</h2>
    </div>

    <!-- 工具栏（搜索、筛选、按钮等） -->
    <div class="toolbar">
        <!-- 搜索框、筛选下拉框、操作按钮 -->
    </div>

    <!-- 数据列表容器 -->
    <div class="data-container">
        <!-- 列表头部 -->
        <div class="data-header">
            <!-- 列标题 -->
        </div>
        <!-- 列表内容（由JS动态填充） -->
        <div id="data-list-body" class="data-list-body">
            <!-- JS会在这里插入数据 -->
        </div>
    </div>
</div>

<!-- 引入CSS和JS -->
<link rel="stylesheet" href="../../../business/css/[业务名称].css">
<script src="../../../business/scripts/business-common.js"></script>
<script src="../../../business/scripts/[业务名称].js"></script>
```

**注意事项**:
- 使用相对路径引入CSS和JS（`../../../` 根据实际层级调整）
- 列表容器必须有唯一ID（如：`id="data-list-body"`）
- 按钮和输入框建议添加 `aria-label` 和 `title` 属性（无障碍访问）

**示例文件**:
- `WebRoot/business/html/executive/CooperationForum/forum-home.html`
- `WebRoot/business/html/nurse/nursing-service/daily-nursing.html`

### 3.2 创建 CSS 样式文件
**文件路径**: `WebRoot/business/css/[业务名称].css`

**命名规范**:
- CSS文件名 = 业务名称 + `.css`
- 例如：`forum.css`、`nursing-service.css`

**主要样式类**:
- `.content-header-row` - 页面标题行
- `.toolbar` - 工具栏样式
- `.search-input` - 搜索框样式
- `.filter-select` - 筛选下拉框样式
- `.btn` / `.btn-primary` - 按钮样式
- `.data-container` - 数据容器
- `.data-header` - 列表头部
- `.data-row` - 数据行
- `.badge` / `.badge-[状态]` - 状态徽章样式
- `.col-[列名]` - 列样式（flex布局）

**示例文件**:
- `WebRoot/business/css/forum.css`
- `WebRoot/business/css/nursing-service.css`

### 3.3 创建 JavaScript 业务脚本
**文件路径**: `WebRoot/business/scripts/[业务名称].js`

**命名规范**:
- JS文件名 = 业务名称 + `.js`
- 例如：`forum.js`、`nursing-service.js`

**主要功能模块**:

#### 1. 防止重复加载
```javascript
if (window.[业务名称]Initialized) {
    console.warn('[业务名称].js 已经加载过，跳过重复初始化');
} else {
    window.[业务名称]Initialized = true;
    // 业务代码
}
```

#### 2. 全局数据存储
```javascript
if (!window.[业务名称]Data) {
    window.[业务名称]Data = [];
}
```

#### 3. 初始化函数
- `init[业务名称]()` - 初始化业务逻辑
- 绑定事件监听器
- 调用数据加载函数

#### 4. 数据获取函数
- `fetch[数据名称]FromDB()` - 从后端获取数据
- 动态计算 API URL（考虑路径问题）
- 使用 `fetch()` 发送请求
- 处理响应并更新全局数据
- 调用渲染函数

#### 5. 数据渲染函数
- `render[数据名称]()` - 渲染数据列表
- 从全局数据中读取数据
- 应用筛选和搜索条件
- 动态生成HTML并插入到DOM

#### 6. 数据更新函数
- `update[数据名称](id, newData)` - 更新数据
- 发送更新请求到后端
- 处理响应
- 刷新列表或更新UI

#### 7. 工具函数
- `escapeHtml(text)` - HTML转义
- `formatDate(date)` - 日期格式化
- 其他辅助函数

**API URL 计算**:
```javascript
let apiUrl;
try {
    const path = window.location.pathname;
    const homeIndex = path.indexOf('/home/');
    if (homeIndex > 0) {
        const basePath = path.substring(0, homeIndex);
        apiUrl = basePath + '/servlet/[角色路径]/[业务名称]Servlet?action=[操作]';
    } else {
        apiUrl = '../../servlet/[角色路径]/[业务名称]Servlet?action=[操作]';
    }
} catch (e) {
    apiUrl = '../../servlet/[角色路径]/[业务名称]Servlet?action=[操作]';
}
```

**暴露全局函数**:
```javascript
window.fetch[数据名称]FromDB = fetch[数据名称]FromDB;
window.render[数据名称] = render[数据名称];
window.update[数据名称] = update[数据名称];
```

**示例文件**:
- `WebRoot/business/scripts/forum.js`
- `WebRoot/business/scripts/nursing-service.js`

### 3.4 更新路由配置
**文件路径**: `WebRoot/business/scripts/business-common.js`

**需要修改的地方**:

#### 1. groupMapping（业务组映射）
```javascript
const groupMapping = {
    // ... 已有映射
    '[业务组名称]': '[实际文件夹名称]', // 新增
};
```

#### 2. contentMapping（内容映射）
```javascript
const contentMapping = {
    // ... 已有映射
    '[内容ID]': '[HTML文件名].html', // 新增
};
```

#### 3. basePath（基础路径）
如果角色路径有变化，检查 `loadBusinessContent` 函数中的 `basePath` 设置。

**注意事项**:
- 确保 `groupMapping` 中的值对应实际的文件夹名称（注意大小写）
- 确保 `contentMapping` 中的 `contentId` 与 HTML 中的 `data-content` 属性值一致

## 四、配置主页导航

### 4.1 更新主页HTML
**文件路径**: `WebRoot/home/[角色路径]/[角色]-home.html`

**需要添加的内容**:
- 横向导航项（如需要）
- 侧边栏导航项
- 确保 `data-group` 和 `data-content` 属性正确

**示例**:
```html
<!-- 横向导航 -->
<li><a href="#业务组名称" data-group="业务组名称">业务名称</a></li>

<!-- 侧边栏导航 -->
<li class="nav-sub-item">
    <a href="#内容ID" data-content="内容ID">子功能名称</a>
</li>
```

## 五、测试流程

### 5.1 编译和部署
1. 在 MyEclipse 中执行 Clean Project
2. Build Project（确保所有 Java 文件编译成功）
3. 重新部署到服务器
4. 重启服务器

### 5.2 功能测试
1. **访问主页**
   - 打开浏览器访问：`http://127.0.0.1:8099/E-HSS/home/[角色路径]/[角色]-home.html`
   - 检查导航是否正常显示

2. **加载业务页面**
   - 点击导航项，检查业务页面是否正确加载
   - 检查 CSS 样式是否正常
   - 检查控制台是否有错误

3. **数据获取测试**
   - 打开浏览器开发者工具（F12）
   - 查看 Network 标签，检查 API 请求是否成功
   - 检查返回的 JSON 数据格式是否正确
   - 检查数据是否正确渲染到页面

4. **数据更新测试**
   - 执行更新操作（如修改状态、创建记录等）
   - 检查数据库是否成功更新
   - 检查前端显示是否同步更新

5. **错误处理测试**
   - 测试网络错误情况
   - 测试无效数据输入
   - 检查错误提示是否友好

## 六、常见问题排查

### 6.1 404 错误
- **问题**: 找不到 HTML/CSS/JS 文件
- **排查**:
  - 检查文件路径是否正确
  - 检查 `business-common.js` 中的路径映射
  - 检查相对路径是否正确（`../../../` 层级）

### 6.2 数据库连接失败
- **问题**: 无法连接数据库
- **排查**:
  - 检查 `DBUtil.java` 中的数据库配置（URL、用户名、密码）
  - 检查数据库服务是否启动
  - 检查数据库名称是否正确

### 6.3 前后端交互失败
- **问题**: API 请求返回错误
- **排查**:
  - 检查 Servlet 的 `@WebServlet` 注解路径是否正确
  - 检查 JS 中的 API URL 计算是否正确
  - 检查 Servlet 中的 `action` 参数处理
  - 查看 MyEclipse Console 中的错误日志

### 6.4 数据不更新
- **问题**: 前端操作后数据库未更新
- **排查**:
  - 检查 DAO 中是否使用了事务控制
  - 检查 `commit()` 是否被调用
  - 检查 SQL 语句是否正确
  - 检查参数是否正确传递

### 6.5 样式不生效
- **问题**: CSS 样式未应用
- **排查**:
  - 检查 CSS 文件路径是否正确
  - 检查 CSS 类名是否与 HTML 中的 class 一致
  - 检查是否有样式冲突（使用浏览器开发者工具）

## 七、文件清单总结

创建一个新业务模块，通常需要创建以下文件：

### 后端文件（Java）
1. **Entity 实体类**: `src/entity/[EntityName].java`
2. **DAO 数据访问对象**: `src/dao/[EntityName]DAO.java`
3. **Servlet 控制器**: `src/servlet/[角色路径]/[业务名称]Servlet.java`

### 前端文件
1. **HTML 页面**: `WebRoot/business/html/[角色路径]/[业务组名称]/[页面名称].html`
2. **CSS 样式**: `WebRoot/business/css/[业务名称].css`
3. **JavaScript 脚本**: `WebRoot/business/scripts/[业务名称].js`

### 配置文件（修改）
1. **路由配置**: `WebRoot/business/scripts/business-common.js`
2. **主页导航**: `WebRoot/home/[角色路径]/[角色]-home.html`

## 八、开发检查清单

- [ ] 数据库表已创建并插入测试数据
- [ ] Entity 实体类已创建（包含所有字段和关联字段）
- [ ] DAO 类已创建（包含查询、创建、更新方法）
- [ ] Servlet 已创建（包含所有 action 处理）
- [ ] HTML 文件已创建（结构完整，包含必要元素）
- [ ] CSS 文件已创建（样式完整，响应式设计）
- [ ] JavaScript 文件已创建（功能完整，错误处理）
- [ ] 路由配置已更新（groupMapping 和 contentMapping）
- [ ] 主页导航已更新（data-group 和 data-content）
- [ ] 代码已编译无错误
- [ ] 功能测试通过（数据获取、更新、显示）
- [ ] 错误处理完善（网络错误、数据验证）

---

**参考示例**:
- 论坛管理模块：`ForumServlet`、`ForumPostDAO`、`forum-home.html`、`forum.css`、`forum.js`
- 护理服务模块：`MedicalServiceServlet_Nurse`、`NursingTaskDAO`、`daily-nursing.html`、`nursing-service.css`、`nursing-service.js`

